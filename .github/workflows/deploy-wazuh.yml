name: Deploy Wazuh Stack

on:
  push:
    branches: [ main, tmp ] #ril
  pull_request:
    branches: [ main ]
  workflow_dispatch: 

jobs:
  scan:
    runs-on: self-hosted
    steps:
      - name: update trivy vulnerability database
        run: trivy image --download-db-only

      - name: scan nginx image
        run: trivy image nginx:${{ vars.NGINX_VERSION }} --exit-code 1 --severity HIGH,CRITICAL

      - name: scan wazuh dashboard image
        run: trivy image wazuh/wazuh-dashboard:${{ vars.WAZUH_VERSION }} --exit-code 1 --severity HIGH,CRITICAL

      - name: scan wazuh manager image
        run: trivy image wazuh/wazuh-manager:${{ vars.WAZUH_VERSION }} --exit-code 1 --severity HIGH,CRITICAL

      - name: scan wazuh indexer image
        run: trivy image wazuh/wazuh-indexer:${{ vars.WAZUH_VERSION }} --exit-code 1 --severity HIGH,CRITICAL
